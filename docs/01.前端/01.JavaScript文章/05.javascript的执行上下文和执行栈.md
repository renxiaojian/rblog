---
title: javascript的执行上下文和执行栈
date: 2021-06-23 14:45:21
permalink: /pages/809787/
categories:
  - 前端
  - JavaScript文章
tags:
  - 
---

## 1 执行上下文

**执行上下文是当前 JavaScript 代码被解析和执行时所在环境的抽象概念。**

### 执行上下文的类型

1. **全局执行上下文** ：只有一个，范围是任何不在函数内部的代码都在全局上下文中。创建一个全局window对象，且`this`指向这个全局对象
2. **函数执行上下文** ：任意多个，函数被调用时，会为该函数创建一个新的上下文。
3. **Eval函数执行上下文** ：`eval` 函数内部也有属于自己的执行上下文

## 2 执行栈

执行栈，即调用栈，是一种后进先出（LIFO）数据结构栈，被用来存储代码运行时创建的所有执行上下文

当js代码首次执行时，会创建一个全局的执行上文且亚茹当前执行栈，每当遇到一个函数调用，都创建一个新的执行上下文并压入栈顶。

执行上下文位于栈顶的函数，函数执行结束，执行上下文会从栈中弹出，控制路程进入当前栈的下一个上下文

## 3 创建执行上下文

### 3.1 阶段1：创建阶段

创建阶段要做三件事

1. `this` 绑定
2. 创建 **词法环境** 
3. 创建 **变量环境**

```
ExecutionContext = {  
  ThisBinding = <this value>,     // 确定this 
  LexicalEnvironment = { ... },   // 词法环境
  VariableEnvironment = { ... },  // 变量环境
}
```
#### 3.1.1 this 绑定

- 在全局执行上下中，`this` 指向全局对象 `window` (浏览器中)
- 在函数执行上下文中, `this` 取决于该函数如何被调用的

#### 3.1.2 词法环境

词法环境内部有两个组件
1. **环境记录器** 是存储变量和函数声明的实际位置
2. **外部环境的引用** 可以访问其父级词法环境（作用域）

词法环境有两种类型
1. **全局环境** 是没有外部环境引用的词法环境，它的外部环境引用是 `null` 。它拥有内建的 Object/Array/等、在环境记录器内的原型函数（关联全局对象，比如 window 对象）还有任何用户定义的全局变量，并且 this的值指向全局对象。
2. **函数环境** 函数内部用户定义的变量存储在环境记录器中。并且引用的外部环境可能是全局环境，或者任何包含此内部函数的外部函数。

环境记录器也有两种类型
1. **声明式环境记录器**存储变量、函数和参数。
2. **对象环境记录器**用来定义出现在全局上下文中的变量和函数的关系。

#### 3.1.2 变量环境

- 变量环境也是一个词法环境，所以它有着上面定义的词法环境的所有属性。
- 在 ES6 中，词法环境组件和变量环境的一个不同就是前者被用来存储函数声明和变量（`let` 和 `const`）绑定，而后者只用来存储 `var` 变量绑定。

### 3.2 阶段2：执行阶段

在此阶段，完成对所有这些变量的分配，最后执行代码。

**注意** : 在执行阶段，如果 JavaScript 引擎不能在源码中声明的实际位置找到 let 变量的值，它会被赋值为 undefined。